# E:\edge_project\config\config.yaml

# =========================================================
# 1. 边端配置 (Edge - Llama.cpp)
# =========================================================
edge:
  # ⚠️ 这里修改为你实际的模型路径
  model:
    path: "models/edge/tinyllama-1.1b-chat-v1.0.Q4_K_M.gguf"
    context_length: 2048
    gpu_layers: 0  # 0=CPU, -1=GPU

  # 服务器设置
  server:
    host: "0.0.0.0"
    port: 8088
    workers: 1

  # -------------------------------------------------------
  # F1 决策模块参数 (大脑参数)
  # -------------------------------------------------------
  f1:
    # 硬件配置（新增）
    hardware:
      device_type: "cpu"  # 可选: "cpu" 或 "gpu"
      # GPU 配置（当 device_type="gpu" 时生效）
      gpu_overload_threshold: 85.0  # GPU 使用率过载阈值（%）
      gpu_memory_critical_mb: 1000  # GPU 显存临界值（MB）
    
    state_monitor:
      state_cache_ttl_ms: 100
      monitor_gpu: false  # 是否监控GPU（与 hardware.device_type 联动）
      default_max_latency_ms: 5000

    # 硬约束 (CPU/GPU过高或延迟要求极低时触发)
    hard_constraints:
      cpu_overload: 90.0
      gpu_overload: 85.0   # 新增：GPU过载阈值
      memory_critical: 500
      ultra_low_latency: 50
      weak_network_rtt: 200.0  # 阶段2: 弱网RTT阈值

    # 评分权重
    scoring_weights:
      latency: 0.4
      cost: 0.1
      quality: 0.3

    latency_estimates:
      edge_only_ms: 30.0
      cloud_direct_ms: 200.0
      speculative_standard_ms: 80.0
    
    # 阶段2: 网络探测
    enable_network_probe: true
    network_probe_interval_ms: 5000
    
    # 阶段3: 历史追踪与自适应
    enable_adaptive: true
    enable_history_scoring: true
    
    history_tracker:
      max_history_size: 100  # 滑动窗口大小
    
    adaptive_threshold:
      target_acceptance_min: 0.75  # 目标接受率下限
      target_acceptance_max: 0.85  # 目标接受率上限
      threshold_step: 0.05         # 阈值调整步长
      smoothing_factor: 0.1        # EMA平滑系数
      threshold_min: 0.50          # 最小阈值
      threshold_max: 0.95          # 最大阈值
      initial_confidence_threshold: 0.80  # 初始置信度阈值
      update_interval: 10          # 每10次执行更新一次
    
    # 默认参数
    confidence_threshold: 0.80
    draft_max_tokens: 64
    default_latency_slo: 150  # 默认延迟SLO (ms)
    
    # 硬件感知参数调整（新增）
    hardware_adaptive:
      # GPU 模式参数
      gpu_mode:
        edge_only_max_tokens: 256      # GPU模式下EDGE_ONLY可生成更多token
        collaborative_draft_tokens: 96  # GPU模式下协同推理draft长度
        task_complexity_threshold: 0.7  # GPU模式下可处理的任务复杂度阈值（越低越能处理复杂任务）
      
      # CPU 模式参数
      cpu_mode:
        edge_only_max_tokens: 128      # CPU模式下EDGE_ONLY生成token较少
        collaborative_draft_tokens: 48  # CPU模式下协同推理draft长度较短
        task_complexity_threshold: 0.8  # CPU模式下只能处理简单任务（阈值较高）

  # F1 置信度参数
  confidence:
    strategy: "max_prob"
    threshold: 0.8
    ensemble_weights:
      max_prob: 0.4
      entropy: 0.3
      top_k_agg: 0.3

  # F3 缓存
  kv_cache:
    enabled: true
    max_size: 1000
    max_seq_len: 2048

  logging:
    level: "INFO"
    file: "logs/edge.log"


# =========================================================
# 2. 通信配置 (连接云端)
# =========================================================
communication:
  # 既然你有 SSH 隧道，这里必须填 localhost
  cloud_endpoint: "http://localhost:8081"
  timeout: 30
  max_retries: 3


# =========================================================
# 3. 全局功能开关
# =========================================================
inference:
  features:
    use_draft_verify: true
    use_confidence_check: true
    use_kv_cache: true
    use_http_communication: true